<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ADA Item Codes â€” Search</title>

  <!-- Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f4f5;
      --card:#ffffff;
      --text:#111111;
      --muted:#6b7280;
      --line:#e5e7eb;
      --chip:#f3f4f6;
      --shadow: 0 10px 30px rgba(0,0,0,.06);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Poppins", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{ color:inherit; text-decoration:none; }
    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(244,244,245,.88);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width:1240px; margin:0 auto;
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800;}
    .dot{width:10px; height:10px; border-radius:999px; background:#111; box-shadow:0 0 0 4px #eaeaec;}
    .actions{display:flex; gap:10px; flex-wrap:wrap;}
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      padding:10px 12px;
      border-radius:14px;
      font-weight:600;
      cursor:pointer;
      font-size:13px;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{background:#fafafa}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn.primary:hover{opacity:.92}

    .wrap{max-width:1240px;margin:0 auto;padding:16px}
    .hero{
      display:flex; flex-direction:column; gap:10px;
      padding:16px;
      border:1px solid var(--line);
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .hero h1{margin:0;font-size:18px;letter-spacing:.2px}
    .hero p{margin:0;color:var(--muted);font-size:13px;line-height:1.4}
    .search-row{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:6px;
    }
    .input{
      flex:1;
      min-width:240px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      outline:none;
      font-size:13px;
      background:#fff;
      font-family:"Poppins", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .input:focus{border-color:#111; box-shadow:0 0 0 3px rgba(17,17,17,.08);}

    .quick{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:6px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--chip);
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{background:#ededf0}

    .grid{
      display:grid;
      grid-template-columns: 1.4fr .6fr;
      gap:14px;
      align-items:start;
      margin-top:14px;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card-title{
      font-size:12px;
      font-weight:800;
      letter-spacing:.8px;
      text-transform:uppercase;
      margin-bottom:10px;
    }

    /* results */
    .results{display:flex; flex-direction:column; gap:10px;}
    .item{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .item-top{
      display:flex; justify-content:space-between; align-items:baseline; gap:10px;
    }
    .code{
      font-weight:800; font-size:18px;
      letter-spacing:.2px;
      display:flex; align-items:center; gap:8px;
    }
    .desc{
      color:var(--muted);
      font-size:12px;
      font-weight:600;
      text-align:right;
      max-width:55%;
    }
    .meta{
      margin-top:8px;
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .badge{
      border:1px solid var(--line);
      background:var(--chip);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:600;
      line-height:1.25;
      display:inline-flex; align-items:center; gap:6px;
    }
    .badge.warn{font-style:italic;}
    .badge.strong{border-color:#111;background:#fff;}
    .details{
      margin-top:10px;
      border-top:1px dashed var(--line);
      padding-top:10px;
      color:#111;
      font-size:12px;
      line-height:1.5;
      display:none;
    }
    .item.open .details{display:block;}
    .toggle{
      margin-left:auto;
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }

    /* side panel */
    .side p{margin:0;color:var(--muted);font-size:12px;line-height:1.45}
    .side .hr{height:1px;background:var(--line);margin:12px 0}
    .kpi{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:8px
    }

    /* modal */
    .modal{
      position:fixed; inset:0; z-index:1000;
      background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center;
      padding:18px;
    }
    .modal.active{display:flex}
    .modal-card{
      width:100%;
      max-width:560px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow: 0 25px 70px rgba(0,0,0,.20);
      padding:16px;
    }
    .modal-head{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    .modal-title{font-weight:800;font-size:14px;text-transform:uppercase;letter-spacing:.2px}
    .xbtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:700;
    }
    .xbtn:hover{background:#fafafa}
    .rule-list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .rule{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .rule b{font-weight:800}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="dot"></span>
        <span>ğŸ¦· ADA Codes</span>
        <span class="small" style="font-weight:600;">ğŸ” Search â€¢ âš ï¸ Warnings â€¢ ğŸ¦ Funds</span>
      </div>
      <div class="actions">
        <a class="btn primary" href="./admin/">ğŸ§‘â€âš•ï¸ Patient Eligibility</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="hero">
      <h1>ğŸ” ADA Item Code Searching</h1>
      <p>è¾“å…¥å…³é”®è¯æˆ–ä»£ç ï¼ˆä¾‹å¦‚ï¼š<b>114</b>ã€<b>crown</b>ã€<b>clean</b>ï¼‰ï¼Œç»“æœä¼šæ˜¾ç¤ºï¼šğŸ“ notesã€âš ï¸ ADA warningsï¼Œä»¥åŠğŸ¦ Fund rulesï¼ˆè‹¥æœ‰ï¼‰ã€‚</p>

      <div class="search-row">
        <input id="q" class="input" placeholder="Search item code / keyword (e.g., 114, crown, clean)"/>
        <button class="btn" id="btnClear">ğŸ§¹ Clear</button>
      </div>

      <div class="quick">
        <span class="chip" onclick="setQ('check up')">âœ¨ Check up</span>
        <span class="chip" onclick="setQ('clean')">ğŸª¥ Clean</span>
        <span class="chip" onclick="setQ('crown')">ğŸ‘‘ Crown</span>
        <span class="chip" onclick="setQ('root canal')">âš¡ Endo</span>
        <span class="chip" onclick="setQ('extraction')">ğŸ§· Extraction</span>
        <span class="chip" onclick="setQ('splint')">ğŸŒ™ Splint</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-title">Results</div>
        <div id="results" class="results"></div>
      </div>

      <div class="card side">
        <div class="card-title">Tips</div>
        <p>â€¢ ç‚¹å‡»æ¯æ¡ç»“æœå³ä¾§ <b>â–¾</b> å¯å±•å¼€ç»†èŠ‚ï¼ˆğŸ“notes / âš ï¸warnings / ğŸ¦fund rulesï¼‰ã€‚</p>
        <p>â€¢ Fund rules ä¼šä»¥ tag å½¢å¼å‡ºç°ï¼Œç‚¹å‡» tag ä¼šå¼¹å‡ºæ›´è¯¦ç»†è¯´æ˜å’Œâ€œå¯¹åº”å“ªäº› item codesâ€ã€‚</p>
        <div class="hr"></div>
        <div class="kpi">
          <span class="badge">ğŸ–¤ Black/White UI</span>
          <span class="badge">ğŸ…¿ï¸ Poppins</span>
          <span class="badge">âš ï¸ Warnings</span>
          <span class="badge">ğŸ¦ Funds</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Fund rule modal -->
  <div class="modal" id="fundModal">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="fundTitle">ğŸ¦ Fund Rules</div>
        <button class="xbtn" onclick="closeFund()">âœ•</button>
      </div>
      <div class="small" id="fundSubtitle"></div>
      <div class="rule-list" id="fundBody"></div>
    </div>
  </div>

<script>
  const DB_PATH = "./db.json";
  const FUND_RULES_PATH = "./data/fund_rules.json"; // optional

  let dbList = [];
  let dbIndex = {};
  let fundRules = null;

  const $ = (id)=>document.getElementById(id);

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
  function pad3(x){
    const digits = String(x ?? "").replace(/\D/g,"").slice(0,3);
    return digits.padStart(3,"0");
  }
  function iconForCode(code){
    const c = Number(code);
    if (!Number.isFinite(c)) return "ğŸ“Œ";
    if (c < 100) return "ğŸ”";
    if (c < 200) return "ğŸª¥";
    if (c < 300) return "ğŸ¦·";
    if (c < 400) return "ğŸ§·";
    if (c < 500) return "âš¡";
    if (c < 600) return "ğŸ§©";
    if (c < 700) return "ğŸ‘‘";
    if (c < 900) return "ğŸ§‘â€ğŸ”§";
    return "ğŸ“Œ";
  }

  async function loadAll(){
    const d = await fetch(DB_PATH + "?v=" + Date.now()).then(r=>r.json());
    if (Array.isArray(d)) dbList = d;
    else if (Array.isArray(d?.items)) dbList = d.items;
    else if (Array.isArray(d?.db)) dbList = d.db;
    else dbList = [];

    dbIndex = {};
    for (const it of dbList){
      const code = pad3(it.code ?? it.c ?? it.itemCode ?? it.item_code);
      if(!code) continue;
      dbIndex[code] = it;
    }

    // fund rules optional
    try{
      fundRules = await fetch(FUND_RULES_PATH + "?v=" + Date.now()).then(r=>r.json());
    }catch(e){
      fundRules = null;
    }
  }

  function setQ(v){
    $("q").value = v;
    render();
  }

  function searchDb(q){
    const query = String(q||"").toLowerCase().trim();
    if(!query) return [];
    const digits = query.replace(/\D/g,"");

    const out = [];
    for (const it of dbList){
      const code = pad3(it.code ?? it.c ?? it.itemCode ?? it.item_code);
      if(!code) continue;

      const desc = it.desc ?? it.d ?? it.description ?? "";
      const cat = it.category ?? it.t ?? it.type ?? "";
      const kw = it.k ?? it.keywords ?? it.keyword ?? "";
      const notes = it.notes ?? it.note ?? "";
      const warn = it.warningText ?? it.r ?? it.warningsText ?? "";

      const hay = `${code} ${desc} ${cat} ${kw} ${notes} ${warn}`.toLowerCase();
      if (digits && code.startsWith(digits.padStart(3,"0").slice(0,3))) { out.push({code,it}); continue; }
      if (hay.includes(query)) out.push({code,it});
    }
    out.sort((a,b)=>a.code.localeCompare(b.code));
    return out.slice(0, 60);
  }

  function getFundBadgesForCode(code){
    if(!fundRules?.funds) return [];
    const badges = [];
    for (const [k, f] of Object.entries(fundRules.funds)){
      const r = f?.rules?.[code];
      if(!r?.frequency?.everyMonths) continue;
      const m = r.frequency.everyMonths;
      badges.push({
        fund: k,
        name: f.name || k,
        text: `${(f.name||k).toUpperCase()}: every ${m}m`,
        link: r.link || null,
        note: r.note || ""
      });
    }
    return badges;
  }

  function openFundModal(code, fundKey){
    const f = fundRules?.funds?.[fundKey];
    if(!f){ return; }

    const rules = f.rules || {};
    const matchingCodes = Object.keys(rules).sort((a,b)=>a.localeCompare(b));

    $("fundTitle").textContent = `ğŸ¦ ${f.name || fundKey} rules`;
    $("fundSubtitle").textContent = `Includes codes: ${matchingCodes.join(", ") || "(none)"}`;

    const body = [];
    for (const c of matchingCodes){
      const r = rules[c];
      const m = r?.frequency?.everyMonths;
      const txt = m ? `every ${m} months` : `(no frequency set)`;
      body.push(`
        <div class="rule">
          <div><b>#${esc(c)}</b> â€” <span>${esc(txt)}</span></div>
          ${r?.note ? `<div class="small" style="margin-top:6px;">${esc(r.note)}</div>` : ``}
          ${r?.link ? `<div class="small" style="margin-top:6px;"><a href="${esc(r.link)}" target="_blank" rel="noopener noreferrer">ğŸ”— more details â†—</a></div>` : ``}
        </div>
      `);
    }
    $("fundBody").innerHTML = body.join("") || `<div class="small">No rules in this fund_rules.json.</div>`;

    $("fundModal").classList.add("active");
  }

  function closeFund(){
    $("fundModal").classList.remove("active");
  }

  function render(){
    const q = $("q").value || "";
    const results = searchDb(q);

    if(!q.trim()){
      $("results").innerHTML = `
        <div class="small">åœ¨ä¸Šé¢æœç´¢æ¡†è¾“å…¥å…³é”®è¯æˆ–ä»£ç å¼€å§‹æœç´¢ã€‚</div>
      `;
      return;
    }

    if(!results.length){
      $("results").innerHTML = `<div class="small">No results.</div>`;
      return;
    }

    $("results").innerHTML = results.map(({code,it}, idx)=>{
      const desc = it.desc ?? it.d ?? it.description ?? "";
      const cat  = it.category ?? it.t ?? it.type ?? "";
      const warn = String(it.warningText ?? it.r ?? "").trim();
      const notes= String(it.notes ?? "").trim();

      const fundBadges = getFundBadgesForCode(code);

      return `
        <div class="item" id="item-${idx}">
          <div class="item-top">
            <div class="code">${iconForCode(code)} #${esc(code)}</div>
            <div class="desc">${esc(desc)}</div>
            <button class="toggle" onclick="toggleItem(${idx})">â–¾</button>
          </div>

          <div class="meta">
            ${cat ? `<span class="badge">ğŸ·ï¸ ${esc(cat)}</span>` : ``}
            ${warn ? `<span class="badge strong">âš ï¸ Warning</span>` : ``}
            ${notes ? `<span class="badge">ğŸ“ Notes</span>` : ``}
            ${fundBadges.length ? `<span class="badge">ğŸ¦ Fund rules</span>` : ``}
          </div>

          <div class="details">
            ${warn ? `<div class="badge warn" style="margin-bottom:8px;">âš ï¸ ${esc(warn)}</div>` : ``}
            ${notes ? `<div class="badge warn" style="margin-bottom:8px;">ğŸ“ ${esc(notes)}</div>` : ``}

            ${fundBadges.length ? `
              <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;">
                ${fundBadges.map(b=>`
                  <span class="chip" onclick="openFundModal('${esc(code)}','${esc(b.fund)}')">
                    ğŸ¦ ${esc(b.text)}
                  </span>
                `).join("")}
              </div>
            ` : `<div class="small">No fund rules found for this code (fund_rules.json optional).</div>`}
          </div>
        </div>
      `;
    }).join("");
  }

  function toggleItem(idx){
    const el = document.getElementById(`item-${idx}`);
    if(!el) return;
    el.classList.toggle("open");
  }

  window.addEventListener("DOMContentLoaded", async ()=>{
    $("results").innerHTML = `<div class="small">Loading db.jsonâ€¦</div>`;
    await loadAll();
    $("q").addEventListener("input", render);
    $("btnClear").addEventListener("click", ()=>{ $("q").value=""; render(); });
    document.getElementById("fundModal").addEventListener("click",(e)=>{ if(e.target.id==="fundModal") closeFund(); });
    render();
  });

  // expose for inline handlers
  window.setQ = setQ;
  window.toggleItem = toggleItem;
  window.closeFund = closeFund;
  window.openFundModal = openFundModal;
</script>
</body>
</html>
