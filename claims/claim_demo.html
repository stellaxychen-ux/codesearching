<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Patient Claim Eligibility</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --bg:#f2f2f7; --card:#fff; --text:#111; --muted:#777;
  --ok:#2e7d32; --warn:#ef6c00; --bad:#c62828; --blue:#007aff;
  --shadow:0 10px 30px rgba(0,0,0,.10); --r:16px;
}
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;padding:18px;color:var(--text);}
.wrap{max-width:980px;margin:0 auto;}
.hdr{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:14px;}
.hdr a{color:var(--blue);text-decoration:none;font-weight:700}
.card{background:var(--card);border-radius:var(--r);padding:18px;box-shadow:var(--shadow);}
.grid{display:grid;gap:12px}
@media(min-width:820px){.grid{grid-template-columns:1.2fr .8fr}}
label{font-size:.85rem;color:var(--muted);font-weight:700}
select,input{width:100%;padding:12px;border-radius:12px;border:1px solid #e6e6ee;font-size:1rem;background:#fff;box-sizing:border-box}
button{padding:12px 14px;border:none;border-radius:12px;background:var(--blue);color:#fff;font-weight:800;font-size:1rem;cursor:pointer}
.btn-ghost{background:#eef1f4;color:#111}
.row{display:flex;gap:10px;flex-wrap:wrap}
.pill{display:inline-flex;gap:8px;align-items:center;background:#eef1f4;border:1px solid #e2e6ea;color:#111;border-radius:999px;padding:8px 10px;font-weight:800;font-size:.9rem}
.msg{padding:10px 12px;border-radius:12px;margin:8px 0;font-weight:700}
.ok{background:#e8f5e9;color:var(--ok)}
.warn{background:#fff3e0;color:var(--warn)}
.bad{background:#ffebee;color:var(--bad)}
.small{font-size:.9rem;font-weight:600}
.table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:10px}
.table td{background:#f7f7fb;padding:10px 12px}
.table tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
.table tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
.codeTag{display:inline-flex;gap:6px;align-items:center;background:#111;color:#fff;border-radius:999px;padding:4px 8px;font-weight:900;font-size:.85rem}
.toothTag{display:inline-flex;gap:6px;align-items:center;background:#ff9500;color:#111;border-radius:999px;padding:4px 8px;font-weight:900;font-size:.85rem}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div class="pill">üßë‚Äç‚öïÔ∏è Patient eligibility</div>
    <a href="../index.html">‚Üê Back to codes</a>
  </div>

  <div class="grid">
    <div class="card">
      <label>Patient</label>
      <select id="patient"></select>

      <div style="height:10px"></div>
      <label>Planned item codes (comma separated). Optional tooth: 613:T16 or 613 T16</label>
      <input id="codes" placeholder="e.g. 114, 251  |  613:T16" />

      <div style="height:12px"></div>
      <div class="row">
        <button onclick="check()">Check eligibility</button>
        <button class="btn-ghost" onclick="toggleHistory()">Search claim history</button>
      </div>

      <div id="result" style="margin-top:12px"></div>
    </div>

    <div class="card" id="historyCard" style="display:none">
      <label>Claim history search (by code/date)</label>
      <input id="histQ" placeholder="e.g. 613 or 2024-02" oninput="renderHistory()" />
      <div id="history"></div>
    </div>
  </div>
</div>

<script>
let claims = {};
let db = {};

Promise.all([
  fetch('./patient_claims.json').then(r=>r.json()),
  fetch('../db.json').then(r=>r.json())
]).then(([c, d])=>{
  claims = c;
  db = {};
  (d||[]).forEach(it=>{ 
    const code = String(it.code||it.c||'').padStart(3,'0');
    db[code] = it; 
  });

  const sel = document.getElementById('patient');
  Object.keys(claims).forEach(p => {
    const o = document.createElement('option');
    o.value = p; o.textContent = p;
    sel.appendChild(o);
  });
});

function parsePlanned(input){
  const tokens = input.split(',').map(s=>s.trim()).filter(Boolean);
  let out = [];
  tokens.forEach(t=>{
    let m = t.match(/(\d{3})\s*[:@]\s*T?(\d{2})/i);
    if(m){ out.push({code:m[1], tooth:m[2]}); return; }
    m = t.match(/(\d{3})\s+T(\d{2})/i);
    if(m){ out.push({code:m[1], tooth:m[2]}); return; }
    m = t.match(/\b(\d{3})\b/);
    if(m){ out.push({code:m[1], tooth:null}); return; }
  });
  return out;
}

function monthsBetween(a, b){
  return (b.getFullYear()-a.getFullYear())*12 + (b.getMonth()-a.getMonth());
}

function lastClaim(history, code, tooth){
  const list = history.filter(x=>x.code===code);
  if(!tooth) return list.slice(-1)[0] || null;
  const match = list.filter(x=>Array.isArray(x.tooth) && x.tooth.includes(tooth)).slice(-1)[0];
  return match || list.slice(-1)[0] || null;
}

function ruleReplacementMonths(code){
  if(['613','615'].includes(code)) return 60; // 5 years (demo rule)
  if(code==='114') return 6;                 // 6 months (demo rule)
  return null;
}

function adaHardBlocks(planned){
  const codes = planned.map(x=>x.code);
  let blocks = [];
  if(codes.includes('251') && (codes.includes('114') || codes.includes('222'))){
    blocks.push('ADA rule: 251 cannot be claimed on the same day as 114 or 222.');
  }
  if(codes.includes('114') && codes.includes('251')){
    blocks.push('ADA rule: 114 cannot be claimed on the same day as 251.');
  }
  return blocks;
}

function check(){
  const p = document.getElementById('patient').value;
  const planned = parsePlanned(document.getElementById('codes').value);
  const history = (claims[p]||[]).slice().sort((a,b)=>a.date.localeCompare(b.date));
  const today = new Date();
  let out = [];

  if(planned.length===0){
    document.getElementById('result').innerHTML = '<div class="msg warn">Enter planned codes first (e.g. 114, 251, 613:T16)</div>';
    return;
  }

  adaHardBlocks(planned).forEach(t=> out.push(`<div class="msg bad">‚ùå ${t}</div>`));

  planned.forEach(({code,tooth})=>{
    const item = db[code] || {};
    const title = item.desc || item.d || item.description || '';
    const warnList = Array.isArray(item.warnings) ? item.warnings : [];
    const last = lastClaim(history, code, tooth);
    const repMonths = ruleReplacementMonths(code);

    const head = `<div class="small"><span class="codeTag">#${code}</span>${tooth?` <span class="toothTag">T${tooth}</span>`:''} ${title?('‚Äî '+title):''}</div>`;

    let flagged = false;

    if(last && repMonths){
      const m = monthsBetween(new Date(last.date), today);
      if(m < repMonths){
        flagged = true;
        const yrs = (repMonths/12);
        out.push(`<div class="msg warn">‚ö†Ô∏è ${head}<div class="small">Last claimed: ${last.date}${last.tooth?` (tooth ${Array.isArray(last.tooth)?last.tooth.join(', '):last.tooth})`:''}. Rule: usually once every ${yrs} years for the same tooth.</div></div>`);
      }
    }

    if(warnList.length){
      flagged = true;
      out.push(`<div class="msg warn">‚ö†Ô∏è ${head}<div class="small">${warnList.slice(0,4).map(x=>String(x)).join('<br>')}</div></div>`);
    }

    if(!flagged){
      out.push(`<div class="msg ok">‚úÖ ${head}<div class="small">No blocking rule detected from history + ADA warnings (demo rules).</div></div>`);
    }
  });

  document.getElementById('result').innerHTML = out.join('');
}

function toggleHistory(){
  const card = document.getElementById('historyCard');
  card.style.display = (card.style.display==='none') ? 'block' : 'none';
  renderHistory();
}

function renderHistory(){
  const card = document.getElementById('historyCard');
  if(card.style.display==='none') return;

  const p = document.getElementById('patient').value;
  const q = (document.getElementById('histQ').value||'').trim().toLowerCase();
  const history = (claims[p]||[]).slice().sort((a,b)=>b.date.localeCompare(a.date));

  const filtered = history.filter(x=>{
    const t = Array.isArray(x.tooth)?x.tooth.join(', '):(x.tooth||'');
    const s = `${x.date} ${x.code} ${t}`.toLowerCase();
    return !q || s.includes(q);
  });

  const rows = filtered.slice(0,200).map(x=>{
    const t = Array.isArray(x.tooth) ? x.tooth.join(', ') : (x.tooth||'');
    return `<tr><td style="width:130px">${x.date}</td><td style="width:90px"><span class="codeTag">#${x.code}</span></td><td>${t?`<span class="toothTag">T${t}</span>`:''}</td></tr>`;
  }).join('');

  document.getElementById('history').innerHTML = `
    <div class="small" style="color:var(--muted)">${filtered.length} records (showing up to 200)</div>
    <table class="table">${rows}</table>
  `;
}

document.addEventListener('change', (e)=>{
  if(e.target && e.target.id==='patient'){ renderHistory(); }
});
</script>
</body>
</html>
