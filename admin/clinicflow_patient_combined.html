<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ClinicFlow — Claims</title>

  <!-- Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f4f5;
      --card:#ffffff;
      --text:#111111;
      --muted:#6b7280;
      --line:#e5e7eb;
      --chip:#f3f4f6;
      --shadow: 0 10px 30px rgba(0,0,0,.06);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:"Poppins", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg);
      color:var(--text);
    }

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(244,244,245,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width:1200px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.3px;
    }
    .brand .dot{
      width:10px; height:10px; border-radius:999px; background:#111;
      box-shadow:0 0 0 4px #eaeaec;
    }
    .actions{ display:flex; gap:10px; align-items:center; }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      padding:10px 12px;
      border-radius:14px;
      font-weight:600;
      cursor:pointer;
      font-size:13px;
    }
    .btn:hover{ background:#fafafa; }
    .btn.primary{
      background:#111; color:#fff; border-color:#111;
    }
    .btn.primary:hover{ opacity:.92; }
    .btn.ghost{
      background:transparent;
    }

    /* Layout */
    .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
    .grid{
      display:grid;
      grid-template-columns: 330px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card-title{
      font-size:12px;
      font-weight:800;
      letter-spacing:.8px;
      text-transform:uppercase;
      color:#111;
      margin-bottom:10px;
    }

    .input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      outline:none;
      font-size:13px;
      background:#fff;
    }
    .input:focus{
      border-color:#111;
      box-shadow:0 0 0 3px rgba(17,17,17,.08);
    }

    /* Patient list */
    .patient-list{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:420px;
      overflow:auto;
      padding-right:4px;
    }
    .patient-row{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .patient-row:hover{ background:#fafafa; }
    .patient-row.active{
      border-color:#111;
      background:#f7f7f7;
    }
    .patient-name{ font-weight:700; font-size:13px; }
    .patient-meta{ font-size:12px; color:var(--muted); }

    /* Right side columns */
    .right{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .right{ grid-template-columns:1fr; }
    }

    /* History timeline */
    .history{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .hrow{
      display:grid;
      grid-template-columns: 112px 1fr;
      gap:12px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
    }
    .htime{
      font-weight:800;
      font-size:12px;
      letter-spacing:.2px;
    }
    .hmain{ display:flex; flex-direction:column; gap:4px; }
    .hcode{
      font-size:14px;
      font-weight:700;
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--chip);
      font-size:12px;
      font-weight:600;
      color:#111;
    }
    .hsub{ font-size:12px; color:var(--muted); }
    .hlimited{
      font-size:12px;
      font-style:italic;
      color:#111;
      opacity:.75;
    }

    /* Eligibility panel */
    .filters{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .filters .full{ grid-column:1 / -1; }

    .small{ font-size:12px; color:var(--muted); }

    #eligibilityResults .row{
      border:1px solid var(--line);
      background:#fff;
      border-radius:16px;
      padding:12px;
      margin-top:10px;
    }
    .code-title{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
    }
    .code-title .num{
      font-weight:800;
      font-size:18px;
      letter-spacing:.2px;
    }
    .code-title .desc{
      color:var(--muted);
      font-size:12px;
      font-weight:600;
    }
    .badges{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .badge{
      border:1px solid var(--line);
      background:var(--chip);
      border-radius:999px;
      padding:5px 10px;
      font-size:12px;
      font-weight:600;
      color:#111;
    }
    .badge.ok{ background:#fff; border-color:#111; }
    .badge.warn{ font-style:italic; }
    .badge.bad{ border-color:#111; }

    /* Simple modal placeholder (keep your existing modal styles if already present) */
    .modal{ display:none; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="dot"></span>
        <span>ClinicFlow</span>
        <span style="font-weight:600;color:var(--muted);font-size:12px;"> & Eligibility</span>
      </div>

      <div class="actions">
        <button class="btn ghost" id="btnApi">API Base</button>
        <button class="btn primary" id="btnAdd">+ Add claim</button>
        <button class="btn" id="btnAi">✨ AI Recommend</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- Left: patient search -->
      <div class="card">
        <div class="card-title">Patients</div>
        <input id="patientSearch" class="input" placeholder="Search patient name…" />
        <div id="patientList" class="patient-list"></div>
      </div>

      <!-- Right: history + eligibility -->
      <div class="right">
        <div class="card">
          <div class="card-title">Patient history</div>
          <div class="small" id="patientHeader"></div>
          <div id="historyWrap" style="margin-top:12px;"></div>
        </div>

        <div class="card">
          <div class="card-title">Eligibility checker</div>

          <div class="filters">
            <div class="full">
              <input id="search" class="input" placeholder="Search item code / keyword (e.g., 114, crown, clean)"/>
            </div>

            <div>
              <input id="asOf" class="input" type="date"/>
              <div class="small" style="margin-top:6px;">As of date</div>
            </div>

            <div>
              <input id="toothFilter" class="input" placeholder="Tooth (optional) e.g., 16"/>
              <div class="small" style="margin-top:6px;">Tooth filter</div>
            </div>

            <div class="full">
              <select id="fundSelect" class="input">
                <option value="bupa">Bupa</option>
                <option value="medibank">Medibank</option>
                <option value="hcf">HCF</option>
                <option value="nib">nib</option>
                <option value="hbf">HBF</option>
                <option value="cbhs">CBHS</option>
              </select>
              <div class="small" style="margin-top:6px;">Fund</div>
            </div>
          </div>

          <div id="eligibilityResults"></div>

          <div id="aiPanel" class="badge warn" style="display:none; margin-top:10px; white-space:pre-wrap; line-height:1.45;"></div>
          <button class="btn" id="btnAiClear" style="display:none;margin-top:10px;">Clear AI</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Keep your existing modals for API Base + Add claim -->
  <!-- (No modal code here — reuse your current implementation.) -->

<script>
/* =========================================================
   Hook points — reuse your existing data + logic here
   ========================================================= */

// These must exist in your current file already after loadAll():
// - claims : { [patientName]: Array<{date,code,tooth,fund,notes}> }
// - fundRules : fund_rules.json loaded object
// - dbMap or db search index
// - loadAll(), renderResults() or equivalent
// - buildEligibilityBadges(code) or your eligibility rendering logic

let selectedPatient = null;

// Replace these with your real implementations if already present:
function isoToday(){ return new Date().toISOString().slice(0,10); }
function pad3(x){ return String(x||"").replace(/\D/g,"").slice(0,3).padStart(3,"0"); }

// TODO: your app already has these globals after loadAll()
// For this template, we assume they exist:

// You already have currentFund() in your file; if not:
function currentFund(){
  return (document.getElementById("fundSelect")?.value || "bupa").toLowerCase();
}
function currentPatient(){
  return selectedPatient;
}

// Escape
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// Patient list
function allPatients(){
  return Object.keys(window.claims || {}).sort((a,b)=>a.localeCompare(b));
}

window.setPatientFromUI = (name)=>{
  selectedPatient = name;
  renderPatientList();
  renderHistory();
  // Call your existing eligibility refresh:
  if (typeof renderResults === "function") renderResults();
};

function renderPatientList(){
  const q = (document.getElementById("patientSearch").value || "").toLowerCase().trim();
  const list = document.getElementById("patientList");
  const names = allPatients().filter(n => !q || n.toLowerCase().includes(q));

  list.innerHTML = names.map(n=>{
    const count = (window.claims[n]||[]).length;
    return `
      <div class="patient-row ${n===selectedPatient?'active':''}" onclick="setPatientFromUI('${escapeHtml(n).replace(/'/g,"&#39;")}')">
        <div>
          <div class="patient-name">${escapeHtml(n)}</div>
          <div class="patient-meta">${count} claims</div>
        </div>
        <div class="patient-meta">›</div>
      </div>
    `;
  }).join("");

  if (!list.innerHTML) {
    list.innerHTML = `<div class="patient-meta" style="padding:10px;">No matches.</div>`;
  }
}

// Limited hint (simple version; you can replace with your more accurate eligibility logic)
function limitedHint(code, fundKey){
  const fr = window.fundRules?.funds?.[fundKey]?.rules?.[code] || null;
  const fb = window.fundRules?.fallback_rules?.[code] || null;
  const rule = fr || fb;
  if (!rule?.frequency?.everyMonths) return "";
  const m = rule.frequency.everyMonths;
  return `Typically limited: every ${m} months${rule.perTooth ? " (per tooth)" : ""}.`;
}

function renderHistory(){
  const wrap = document.getElementById("historyWrap");
  const header = document.getElementById("patientHeader");
  const name = currentPatient();

  if (!name){
    wrap.innerHTML = `<div class="patient-meta">Select a patient.</div>`;
    if (header) header.textContent = "";
    return;
  }

  const list = (window.claims[name] || []).slice().sort((a,b)=>String(b.date).localeCompare(String(a.date)));
  if (header) header.innerHTML = `<span style="font-weight:800">${escapeHtml(name)}</span> <span style="color:var(--muted)">· ${list.length} claims</span>`;

  if (!list.length){
    wrap.innerHTML = `<div class="patient-meta">No claim history.</div>`;
    return;
  }

  const fundKey = currentFund();

  wrap.innerHTML = `<div class="history">` + list.map(cl=>{
    const code = pad3(cl.code);
    const tooth = Array.isArray(cl.tooth) ? cl.tooth.join(", ") : (cl.tooth ? String(cl.tooth) : "—");
    const fund = (cl.fund || "").toUpperCase();
    const hint = limitedHint(code, (cl.fund || fundKey || "").toLowerCase());

    return `
      <div class="hrow">
        <div class="htime">${escapeHtml(cl.date)}</div>
        <div class="hmain">
          <div class="hcode">#${escapeHtml(code)} ${fund ? `<span class="chip">${fund}</span>` : ""}</div>
          <div class="hsub">Tooth: ${escapeHtml(tooth)}${cl.notes ? ` · ${escapeHtml(cl.notes)}` : ""}</div>
          ${hint ? `<div class="hlimited">⟡ ${escapeHtml(hint)}</div>` : ``}
        </div>
      </div>
    `;
  }).join("") + `</div>`;
}

/* Eligibility UI render:
   - If you already have a renderer, call it.
   - If not, you can render cards with buildEligibilityBadges(code).
*/
function renderResults(){
  // TODO: plug your existing eligibility search results here.
  // For now, placeholder:
  const box = document.getElementById("eligibilityResults");
  box.innerHTML = `<div class="patient-meta" style="margin-top:10px;">(Hook your existing eligibility renderer here.)</div>`;
}

/* AI Recommend button — call your existing runAiRecommend if already added */
async function runAiRecommend(){
  // If you already implemented this earlier, keep it. Placeholder:
  const panel = document.getElementById("aiPanel");
  const clearBtn = document.getElementById("btnAiClear");
  panel.style.display = "block";
  clearBtn.style.display = "inline-block";
  panel.textContent = "AI recommend: (wire to your existing /api/ai-recommend endpoint)";
}

window.addEventListener("DOMContentLoaded", async ()=>{
  // Default date
  const asOf = document.getElementById("asOf");
  if (asOf && !asOf.value) asOf.value = isoToday();

  // Bind inputs
  document.getElementById("patientSearch")?.addEventListener("input", renderPatientList);
  document.getElementById("fundSelect")?.addEventListener("change", ()=>{ renderHistory(); renderResults(); });
  document.getElementById("search")?.addEventListener("input", renderResults);
  document.getElementById("toothFilter")?.addEventListener("input", renderResults);

  document.getElementById("btnAi")?.addEventListener("click", runAiRecommend);
  document.getElementById("btnAiClear")?.addEventListener("click", ()=>{
    const panel = document.getElementById("aiPanel");
    panel.style.display = "none"; panel.textContent = "";
    document.getElementById("btnAiClear").style.display="none";
  });

  // TODO: call your real loadAll() to load JSON data
  if (typeof loadAll === "function") {
    await loadAll();
  }

  // Init selected patient
  const names = allPatients();
  selectedPatient = names[0] || null;
  renderPatientList();
  renderHistory();
  renderResults();
});
  /* =========================
   UI v2 connectors (REQUIRED)
   ========================= */

// If your original file already has currentPatient()/set patient logic,
// we keep a local selectedPatient and expose currentPatient() for compatibility.
let selectedPatient = null;

// Ensure currentPatient() exists for any existing logic.
if (typeof window.currentPatient !== "function") {
  window.currentPatient = function currentPatient() {
    return selectedPatient;
  };
}

// If your original code uses currentFund(), keep it; otherwise use fundSelect.
if (typeof window.currentFund !== "function") {
  window.currentFund = function currentFund() {
    return (document.getElementById("fundSelect")?.value || "bupa").toLowerCase();
  };
}

// Robust HTML escape
function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

function allPatientsFromClaims(){
  const c = window.claims || {};
  return Object.keys(c).sort((a,b)=>a.localeCompare(b));
}

function renderPatientListV2(){
  const input = document.getElementById("patientSearch");
  const listEl = document.getElementById("patientList");
  if (!listEl) return;

  const q = (input?.value || "").toLowerCase().trim();
  const names = allPatientsFromClaims().filter(n => !q || n.toLowerCase().includes(q));

  listEl.innerHTML = names.map(n=>{
    const count = (window.claims?.[n] || []).length;
    return `
      <div class="patient-row ${n===selectedPatient ? "active" : ""}" data-name="${esc(n)}">
        <div>
          <div class="patient-name">${esc(n)}</div>
          <div class="patient-meta">${count} claims</div>
        </div>
        <div class="patient-meta">›</div>
      </div>
    `;
  }).join("") || `<div class="patient-meta" style="padding:10px;">No matches.</div>`;

  // click handlers
  listEl.querySelectorAll(".patient-row").forEach(row=>{
    row.addEventListener("click", ()=>{
      selectedPatient = row.getAttribute("data-name");
      renderPatientListV2();
      if (typeof window.renderHistory === "function") window.renderHistory();
      if (typeof window.renderResults === "function") window.renderResults();
    });
  });
}

// If you replaced history renderer with the template version, ensure it uses window.claims
// and selectedPatient. If your original had renderHistory, keep it. If not, provide one:
if (typeof window.renderHistory !== "function") {
  window.renderHistory = function renderHistory(){
    const wrap = document.getElementById("historyWrap");
    const header = document.getElementById("patientHeader");
    if(!wrap) return;

    const name = selectedPatient;
    const items = (window.claims?.[name] || []).slice()
      .sort((a,b)=>String(b.date).localeCompare(String(a.date)));

    if(header){
      header.innerHTML = name
        ? `<span style="font-weight:800">${esc(name)}</span> <span style="color:var(--muted)">· ${items.length} claims</span>`
        : "";
    }

    if(!name){
      wrap.innerHTML = `<div class="patient-meta">Select a patient.</div>`;
      return;
    }
    if(!items.length){
      wrap.innerHTML = `<div class="patient-meta">No claim history.</div>`;
      return;
    }

    const fundKey = window.currentFund();
    const fr = (code, fund) => window.fundRules?.funds?.[fund]?.rules?.[code] || null;
    const fb = (code) => window.fundRules?.fallback_rules?.[code] || null;

    wrap.innerHTML = `<div class="history">` + items.map(cl=>{
      const code = String(cl.code||"").replace(/\D/g,"").slice(0,3).padStart(3,"0");
      const tooth = Array.isArray(cl.tooth) ? cl.tooth.join(", ") : (cl.tooth ? String(cl.tooth) : "—");
      const fund = (cl.fund || "").toUpperCase();

      const rule = fr(code, (cl.fund||fundKey||"").toLowerCase()) || fb(code);
      const hint = rule?.frequency?.everyMonths
        ? `Typically limited: every ${rule.frequency.everyMonths} months${rule.perTooth ? " (per tooth)" : ""}.`
        : "";

      return `
        <div class="hrow">
          <div class="htime">${esc(cl.date)}</div>
          <div class="hmain">
            <div class="hcode">#${esc(code)} ${fund ? `<span class="chip">${esc(fund)}</span>` : ""}</div>
            <div class="hsub">Tooth: ${esc(tooth)}${cl.notes ? ` · ${esc(cl.notes)}` : ""}</div>
            ${hint ? `<div class="hlimited">⟡ ${esc(hint)}</div>` : ``}
          </div>
        </div>
      `;
    }).join("") + `</div>`;
  };
}

// Wire top buttons to your existing modal functions
function wireTopButtonsV2(){
  document.getElementById("btnAdd")?.addEventListener("click", ()=>{
    if (typeof window.openAdd === "function") window.openAdd();
    else {
      alert("openAdd() not found. Make sure your original modal code is included.");
    }
  });

  document.getElementById("btnApi")?.addEventListener("click", ()=>{
    // if your original uses apiModal open logic, call it; otherwise just open modal by id
    if (typeof window.openApi === "function") window.openApi();
    else {
      const m = document.getElementById("apiModal");
      if (m) m.classList.add("active");
    }
  });

  document.getElementById("btnAi")?.addEventListener("click", ()=>{
    if (typeof window.runAiRecommend === "function") window.runAiRecommend();
    else alert("runAiRecommend() not found.");
  });

  document.getElementById("btnAiClear")?.addEventListener("click", ()=>{
    const panel = document.getElementById("aiPanel");
    if(panel){ panel.style.display="none"; panel.textContent=""; }
    document.getElementById("btnAiClear").style.display="none";
  });
}

// IMPORTANT: call after your original loadAll finishes
async function initUiV2(){
  // Ensure data is loaded
  if (typeof window.loadAll === "function") {
    await window.loadAll();
  }

  const names = allPatientsFromClaims();
  selectedPatient = selectedPatient || names[0] || null;

  // bind search
  document.getElementById("patientSearch")?.addEventListener("input", renderPatientListV2);

  renderPatientListV2();
  window.renderHistory?.();
  window.renderResults?.();
  wireTopButtonsV2();
}

// Start after DOM ready
window.addEventListener("DOMContentLoaded", ()=>{
  const asOf = document.getElementById("asOf");
  if(asOf && !asOf.value) asOf.value = new Date().toISOString().slice(0,10);

  // Avoid double init if you already call loadAll elsewhere:
  initUiV2();
});

</script>
</body>
</html>
