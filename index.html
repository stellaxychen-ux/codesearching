<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ADA Dental Item Codes (AU)</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --primary:#007aff;
      --secondary:#5856d6;
      --bg:#f2f2f7;
      --card:#ffffff;
      --text:#1c1c1e;
      --muted:#8e8e93;
      --radius:16px;
      --shadow:0 4px 20px rgba(0,0,0,.06);
    }

    body{
      margin:0;
      padding:20px;
      background:var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,sans-serif;
      color:var(--text);
      display:flex;
      justify-content:center;
    }

    .app{
      width:100%;
      max-width:900px;
      display:flex;
      flex-direction:column;
      gap:20px;
    }

    .header{
      background:var(--card);
      padding:16px 20px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }

    .title{
      font-weight:800;
      font-size:1.2rem;
      background:linear-gradient(45deg,var(--primary),var(--secondary));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      display:flex;
      gap:10px;
      align-items:center;
      white-space:nowrap;
    }

    .badge{
      font-size:.75rem;
      background:#eef1f4;
      color:var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-weight:600;
      white-space:nowrap;
    }

    .hero{
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      padding:36px 28px;
      border-radius:var(--radius);
      color:#fff;
      box-shadow:var(--shadow);
      text-align:center;
    }

    .hero input{
      margin-top:16px;
      width:100%;
      max-width:620px;
      padding:18px 24px 18px 48px;
      border:none;
      border-radius:999px;
      font-size:1.05rem;
      outline:none;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }

    .search-wrap{
      position:relative;
      display:flex;
      justify-content:center;
    }

    .search-wrap i{
      position:absolute;
      left:calc(50% - 300px + 18px);
      top:50%;
      transform:translateY(-50%);
      color:#999;
    }

    .results{
      display:grid;
      gap:12px;
    }

    .card{
      background:#fff;
      padding:16px 20px;
      border-radius:12px;
      border-left:6px solid #ddd;
      box-shadow:0 2px 10px rgba(0,0,0,.04);
      transition:.2s;
    }

    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(0,0,0,.08);
    }

    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .code{
      font-weight:800;
      font-size:1.3rem;
    }

    .cat{
      font-size:.75rem;
      letter-spacing:1px;
      color:#888;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }

    .desc{
      margin-top:6px;
      font-size:1.02rem;
      color:#444;
      line-height:1.35;
    }

    .meta{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      color:#9aa0a6;
      font-size:.85rem;
    }

    .copy-btn{
      border:none;
      background:#eef1f4;
      color:#333;
      font-weight:700;
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      transition:.15s;
    }
    .copy-btn:hover{ transform: translateY(-1px); }

    .sym{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:.72rem;
      font-weight:800;
      color:#6b7280;
      background:#f3f4f6;
      padding:4px 8px;
      border-radius:999px;
    }

    .empty{
      background:var(--card);
      border-radius:var(--radius);
      padding:40px;
      text-align:center;
      color:#999;
      box-shadow:var(--shadow);
    }

    /* 分类颜色 */
    .cat-Diag{border-color:#4caf50}
    .cat-Prev{border-color:#8bc34a}
    .cat-Perio{border-color:#ff9800}
    .cat-Surg{border-color:#f44336}
    .cat-Endo{border-color:#ff2d55}
    .cat-Rest{border-color:#2196f3}
    .cat-Pros{border-color:#00bcd4}
    .cat-Ortho{border-color:#9c27b0}
    .cat-Impl{border-color:#795548}
    .cat-Gen{border-color:#607d8b}
  </style>
</head>

<body>
<div class="app">

  <div class="header">
    <div class="title"><i class="fas fa-tooth"></i> ADA Item Codes</div>
    <div class="badge" id="dbStatus">Loading db.json…</div>
  </div>

  <div class="hero">
    <h2 style="margin:0">Australian Dental Association</h2>
    <p style="opacity:.9;margin:6px 0 0">Search by code or keyword</p>

    <div class="search-wrap">
      <i class="fas fa-search"></i>
      <input id="q" placeholder="e.g. 251, extraction, crown…" autocomplete="off" />
    </div>
  </div>

  <div id="results" class="results">
    <div class="empty">
      <i class="fas fa-search" style="font-size:2rem;opacity:.25"></i>
      <p>Ready to search ADA database</p>
    </div>
  </div>

</div>

<script>
  // ---------- Helpers ----------
  function esc(s=''){
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function categoryFor(codeStr){
    // 3-digit item number → bucket by hundreds
    const n = parseInt(codeStr, 10);
    if (Number.isNaN(n)) return 'Gen';
    const h = Math.floor(n / 100);
    const map = {
      0: 'Diag',
      1: 'Prev',
      2: 'Perio',
      3: 'Surg',
      4: 'Endo',
      5: 'Rest',
      6: 'Pros',
      7: 'Pros',
      8: 'Ortho',
      9: 'Gen'
    };
    return map[h] || 'Gen';
  }

  function debounce(fn, wait=160){
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), wait);
    };
  }

  async function copyText(text, btn){
    try{
      await navigator.clipboard.writeText(text);
      const old = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = old, 1200);
    }catch(e){
      btn.textContent = 'Copy failed';
      setTimeout(() => btn.textContent = 'Copy code', 1200);
    }
  }

  // ---------- Data ----------
  // db.json format you have:
  // [
  //   { "code": "011", "title": "...", "symbols": ["#"] },
  //   ...
  // ]
  let DB = [];
  let INDEX = [];

  const input = document.getElementById('q');
  const results = document.getElementById('results');
  const dbStatus = document.getElementById('dbStatus');

  function buildIndex(){
    INDEX = DB.map(x => {
      const code = String(x.code || '').padStart(3, '0');
      const title = String(x.title || '');
      const symbols = Array.isArray(x.symbols) ? x.symbols : [];
      const cat = categoryFor(code);
      return {
        c: code,
        d: title,
        t: cat,
        symbols,
        _title: title.toLowerCase()
      };
    });
  }

  function renderEmpty(msg){
    results.innerHTML = `
      <div class="empty">
        <i class="fas fa-search" style="font-size:2rem;opacity:.25"></i>
        <p>${esc(msg)}</p>
      </div>
    `;
  }

  function renderList(list, totalCount){
    results.innerHTML =
      list.map(x => {
        const sym = (x.symbols && x.symbols.length)
          ? `<span class="sym">${esc(x.symbols.join(' '))}</span>`
          : '';

        return `
          <div class="card cat-${esc(x.t)}">
            <div class="row">
              <div class="code">#${esc(x.c)}</div>
              <div class="cat">${esc(x.t)} ${sym}</div>
            </div>

            <div class="desc">${esc(x.d)}</div>

            <div class="meta">
              <span>${esc(x.c)} · ${esc(x.t)}</span>
              <button class="copy-btn" data-code="${esc(x.c)}">Copy code</button>
            </div>
          </div>
        `;
      }).join('') +
      (totalCount > list.length
        ? `<div class="empty" style="padding:16px;">Showing ${list.length} of ${totalCount}. Refine your keywords.</div>`
        : '');

    // bind copy buttons
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', () => copyText(btn.dataset.code, btn));
    });
  }

  function searchCore(){
    const q = input.value.toLowerCase().trim();

    if(!q){
      renderEmpty('Ready to search ADA database');
      return;
    }

    // token search: all words must exist in title OR code prefix matches
    const tokens = q.split(/\s+/).filter(Boolean);

    const hits = INDEX.filter(x => {
      if (x.c.startsWith(q)) return true;
      if (tokens.length === 1) return x._title.includes(tokens[0]);
      return tokens.every(t => x._title.includes(t));
    });

    // sort: code prefix matches first, then alphabetical
    hits.sort((a,b) => {
      const ap = a.c.startsWith(q) ? 0 : 1;
      const bp = b.c.startsWith(q) ? 0 : 1;
      if (ap !== bp) return ap - bp;
      return a.c.localeCompare(b.c);
    });

    const top = hits.slice(0, 80);
    if (!hits.length){
      renderEmpty(`No results for "${q}"`);
      return;
    }
    renderList(top, hits.length);
  }

  const search = debounce(searchCore, 140);

  input.addEventListener('input', search);

  // ---------- Load db.json ----------
  (async function init(){
    try{
      const r = await fetch('./db.json', { cache: 'no-store' });
      if(!r.ok) throw new Error('HTTP ' + r.status);
      DB = await r.json();

      buildIndex();
      dbStatus.textContent = `Loaded ${INDEX.length} items`;
      renderEmpty('Ready to search ADA database');
    }catch(err){
      dbStatus.textContent = 'Failed to load db.json';
      results.innerHTML = `
        <div class="empty">
          <p><b>db.json load failed</b></p>
          <p style="margin-top:8px">
            Make sure <code>db.json</code> is in the same folder as <code>index.html</code>.
          </p>
        </div>
      `;
    }
  })();
</script>

</body>
</html>
