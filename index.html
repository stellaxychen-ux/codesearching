<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClinicFlow Admin â€” Add Claim</title>
  <style>
    :root{
      --bg:#f2f2f7; --card:#fff; --text:#111; --muted:#6b7280; --blue:#007aff;
      --ok:#1b5e20; --warn:#b45309; --bad:#b91c1c; --shadow:0 10px 28px rgba(0,0,0,.10); --r:16px;
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;padding:16px;color:var(--text);}
    .wrap{max-width:1050px;margin:0 auto;}
    .hdr{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px;}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#eef1f4;border:1px solid #e2e6ea;color:#111;border-radius:999px;padding:8px 10px;font-weight:950;font-size:.9rem}
    a{color:var(--blue);text-decoration:none;font-weight:900}
    .card{background:var(--card);border-radius:var(--r);padding:16px;box-shadow:var(--shadow);}
    .grid{display:grid;gap:12px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    label{font-size:.82rem;color:var(--muted);font-weight:950}
    select,input,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #e6e6ee;font-size:1rem;background:#fff}
    textarea{min-height:92px; resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    button{padding:12px 14px;border:none;border-radius:12px;background:var(--blue);color:#fff;font-weight:950;font-size:1rem;cursor:pointer}
    button.secondary{background:#eef1f4;color:#111;border:1px solid #e2e6ea}
    .msg{padding:10px 12px;border-radius:12px;margin:8px 0;font-weight:950}
    .ok{background:#e8f5e9;color:var(--ok)}
    .warn{background:#fff3e0;color:var(--warn)}
    .bad{background:#ffebee;color:var(--bad)}
    .small{font-size:.9rem;font-weight:850}
    code{background:#f7f7fb;padding:2px 6px;border-radius:8px}
    .kicker{font-size:.78rem;font-weight:950;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div class="pill">ğŸ› ï¸ ClinicFlow Admin â€” Add Claim</div>
    <div style="display:flex;gap:10px;align-items:center">
      <a href="../claims/claim_demo.html">Open Eligibility Demo</a>
      <a href="../index.html">â† Back to Codes</a>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="kicker">Connection</div>
      <div class="row">
        <div style="flex:1;min-width:260px">
          <label>API Base (Vercel) â€” ç¬¬ä¸€æ¬¡éœ€è¦ä½ å¡«ä¸€æ¬¡</label>
          <input id="apiBase" placeholder="e.g. https://codesearching-api.vercel.app" />
          <div class="small" style="color:var(--muted);margin-top:6px">
            è¿™æ˜¯ä½ çš„â€œå®‰å…¨å†™å…¥ APIâ€ï¼ˆVercelï¼‰ã€‚æˆ‘ä»¬ä¸ä¼šæŠŠ GitHub Token æ”¾åœ¨ç½‘é¡µé‡Œã€‚
          </div>
        </div>
        <div>
          <button class="secondary" onclick="saveApiBase()">Save</button>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="kicker">Add a new claim</div>

      <div class="row">
        <div style="flex:1;min-width:240px">
          <label>Patient (existing)</label>
          <select id="patientSelect"></select>
        </div>
        <div style="flex:1;min-width:240px">
          <label>â€¦or New patient name</label>
          <input id="newPatient" placeholder="Type to create a new patient key" />
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <div style="flex:1;min-width:210px">
          <label>Date</label>
          <input id="date" type="date" />
        </div>
        <div style="flex:1;min-width:210px">
          <label>Fund</label>
          <select id="fund">
            <option value="bupa">Bupa</option>
            <option value="medibank">Medibank</option>
            <option value="hcf">HCF</option>
            <option value="nib">nib</option>
            <option value="hif">HIF</option>
            <option value="westfund">Westfund</option>
            <option value="guhealth">GU Health</option>
            <option value="ahm">ahm</option>
          </select>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <div style="flex:1;min-width:210px">
          <label>Item code (3 digits)</label>
          <input id="code" placeholder="e.g. 114" inputmode="numeric" />
        </div>
        <div style="flex:1;min-width:210px">
          <label>Tooth (optional)</label>
          <input id="tooth" placeholder="e.g. 16 or 16,26" />
        </div>
      </div>

      <div style="height:10px"></div>
      <label>Notes (optional)</label>
      <textarea id="notes" placeholder="Any staff notes..."></textarea>

      <div style="height:12px"></div>
      <div class="row">
        <button onclick="submitClaim()">Save â†’ Commit to GitHub</button>
        <button class="secondary" onclick="reloadData()">Reload data</button>
      </div>

      <div id="status" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <div class="kicker">Live preview</div>
      <div class="small" style="color:var(--muted);line-height:1.5">
        è¿™é¡µä¼šè¯»å–ä½  GitHub Pages çš„ï¼š
        <ul style="margin:8px 0 0 18px; padding:0; color:var(--muted)">
          <li><code>../data/patient_claims.json</code>ï¼ˆå”¯ä¸€æ•°æ®æºï¼‰</li>
          <li><code>../data/fund_rules.json</code></li>
          <li><code>../db.json</code></li>
        </ul>
      </div>
      <div style="height:10px"></div>
      <div class="kicker">Loaded patient count</div>
      <div id="stats" class="msg ok">Loadingâ€¦</div>

      <div style="height:10px"></div>
      <div class="kicker">Patient history (quick)</div>
      <input id="q" placeholder="Search: 613 / 2024 / 16" oninput="renderHistory()" />
      <div id="history" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<script>
const OWNER_REPO = "stellaxychen-ux/codesearching";
const CLAIMS_PATH = "data/patient_claims.json";

let claims = {};
let db = {};

function todayISO(){
  const d = new Date();
  return d.toISOString().slice(0,10);
}
function pad3(s){
  const x = String(s||"").replace(/\D/g,"").slice(0,3);
  return x.length ? x.padStart(3,"0") : "";
}
function parseTooth(s){
  const raw = (s||"").trim();
  if(!raw) return null;
  const parts = raw.split(",").map(x=>x.trim()).filter(Boolean);
  const cleaned = parts.map(p=>p.replace(/\D/g,"")).filter(Boolean);
  if(!cleaned.length) return null;
  return cleaned;
}
function saveApiBase(){
  const v = document.getElementById("apiBase").value.trim().replace(/\/$/,"");
  if(!v){
    setStatus("è¯·è¾“å…¥ Vercel API Baseï¼Œä¾‹å¦‚ï¼šhttps://xxxx.vercel.app", "warn");
    return;
  }
  localStorage.setItem("clinicflow_api_base", v);
  setStatus("âœ… Saved API base to browser storage.", "ok");
}
function loadApiBase(){
  const v = localStorage.getItem("clinicflow_api_base") || "";
  document.getElementById("apiBase").value = v;
}
function setStatus(msg, cls){
  document.getElementById("status").innerHTML = `<div class="msg ${cls}">${msg}</div>`;
}
function setStats(msg, cls){
  document.getElementById("stats").className = "msg " + cls;
  document.getElementById("stats").textContent = msg;
}
async function reloadData(){
  setStatus("Loading dataâ€¦", "warn");
  try{
    const [c, d] = await Promise.all([
      fetch("../" + CLAIMS_PATH + "?v=" + Date.now()).then(r=>r.json()),
      fetch("../db.json?v=" + Date.now()).then(r=>r.json())
    ]);
    claims = c || {};
    db = {};
    (d||[]).forEach(it=>{
      const code = String(it.code||it.c||"").padStart(3,"0");
      db[code] = it;
    });
    populatePatients();
    setStats(`âœ… Loaded ${Object.keys(claims).length} patients`, "ok");
    setStatus("âœ… Data loaded.", "ok");
    renderHistory();
  }catch(e){
    console.error(e);
    setStatus("âŒ Failed to load JSON. Check file path: ../data/patient_claims.json", "bad");
    setStats("âŒ Failed to load", "bad");
  }
}
function populatePatients(){
  const sel = document.getElementById("patientSelect");
  sel.innerHTML = "";
  Object.keys(claims).sort().forEach(name=>{
    const o = document.createElement("option");
    o.value = name; o.textContent = name;
    sel.appendChild(o);
  });
}
function renderHistory(){
  const sel = document.getElementById("patientSelect");
  const name = sel.value;
  const q = (document.getElementById("q").value||"").trim().toLowerCase();
  const list = (claims[name]||[]).slice().sort((a,b)=>String(b.date).localeCompare(String(a.date)));
  const filtered = list.filter(x=>{
    const tooth = Array.isArray(x.tooth)?x.tooth.join(","):(x.tooth||"");
    const s = `${x.date} ${x.code} ${tooth} ${(x.notes||"")}`.toLowerCase();
    return !q || s.includes(q);
  }).slice(0,120);

  if(!name){
    document.getElementById("history").innerHTML = `<div class="msg warn">No patient selected.</div>`;
    return;
  }
  if(!filtered.length){
    document.getElementById("history").innerHTML = `<div class="msg warn">No records.</div>`;
    return;
  }

  const rows = filtered.map(x=>{
    const tooth = Array.isArray(x.tooth)?x.tooth.join(","):(x.tooth||"");
    const title = (db[x.code] && (db[x.code].desc || db[x.code].d)) || "";
    return `<div class="msg ok">
      <span class="mono">${x.date}</span> Â· <b>#${x.code}</b>${tooth?` Â· T${tooth}`:""}${title?`<br><span class="small" style="color:var(--muted)">${title}</span>`:""}
    </div>`;
  }).join("");
  document.getElementById("history").innerHTML = rows;
}
document.getElementById("patientSelect").addEventListener("change", renderHistory);

function validate(){
  const patientExisting = document.getElementById("patientSelect").value;
  const patientNew = document.getElementById("newPatient").value.trim();
  const patient = patientNew || patientExisting;

  const date = document.getElementById("date").value;
  const code = pad3(document.getElementById("code").value);
  const tooth = parseTooth(document.getElementById("tooth").value);
  const fund = document.getElementById("fund").value;
  const notes = document.getElementById("notes").value.trim();

  if(!patient) return {ok:false, msg:"è¯·é€‰æ‹©ç—…äººæˆ–è¾“å…¥æ–°ç—…äººåå­—"};
  if(!date) return {ok:false, msg:"è¯·é€‰æ‹©æ—¥æœŸ"};
  if(!code || code.length!==3) return {ok:false, msg:"Item code å¿…é¡»æ˜¯ 3 ä½æ•°å­—ï¼ˆä¾‹å¦‚ 114ï¼‰"};

  if(tooth){
    for(const t of tooth){
      const n = parseInt(t,10);
      if(!(n>=11 && n<=85)){
        return {ok:false, msg:`Tooth number çœ‹èµ·æ¥ä¸å¯¹ï¼š${t}ï¼ˆç¤ºä¾‹ï¼š16 æˆ– 16,26ï¼‰`};
      }
    }
  }

  return {ok:true, data:{patient, date, code, tooth, fund, notes}};
}

async function submitClaim(){
  const apiBase = (document.getElementById("apiBase").value||"").trim().replace(/\/$/,"");
  if(!apiBase){
    setStatus("è¯·å…ˆå¡«å†™å¹¶ä¿å­˜ API Baseï¼ˆVercel URLï¼‰", "warn");
    return;
  }
  const v = validate();
  if(!v.ok){
    setStatus("âš ï¸ " + v.msg, "warn");
    return;
  }

  const p = v.data.patient;
  const list = claims[p] || [];
  const toothKey = Array.isArray(v.data.tooth) ? v.data.tooth.join(",") : "";
  const dup = list.some(x => x.date===v.data.date && x.code===v.data.code && ((Array.isArray(x.tooth)?x.tooth.join(","):"")===toothKey));
  if(dup){
    setStatus("âš ï¸ çœ‹èµ·æ¥æ˜¯é‡å¤è®°å½•ï¼ˆåŒä¸€å¤©åŒ code åŒ toothï¼‰ã€‚å¦‚ç¡®å®šéœ€è¦é‡å¤ï¼Œè¯·å…ˆåœ¨ JSON é‡Œç¡®è®¤ã€‚", "warn");
    return;
  }

  setStatus("Savingâ€¦", "warn");

  try{
    const resp = await fetch(apiBase + "/api/add-claim", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        owner_repo: OWNER_REPO,
        path: CLAIMS_PATH,
        claim: v.data
      })
    });

    const out = await resp.json().catch(()=>({}));
    if(!resp.ok){
      const msg = out && out.error ? out.error : ("HTTP " + resp.status);
      setStatus("âŒ Save failed: " + msg, "bad");
      return;
    }

    setStatus(`âœ… Committed to GitHub. Commit: <a href="${out.commit_url}" target="_blank">${(out.commit_sha||"").slice(0,7) || "open"}</a>`, "ok");
    document.getElementById("code").value = "";
    document.getElementById("tooth").value = "";
    document.getElementById("notes").value = "";
    await reloadData();
  }catch(e){
    console.error(e);
    setStatus("âŒ Network error. Check API Base and CORS.", "bad");
  }
}

(function init(){
  loadApiBase();
  document.getElementById("date").value = todayISO();
  reloadData();
})();
</script>
</body>
</html>
